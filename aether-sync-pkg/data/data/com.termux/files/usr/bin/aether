#!/data/data/com.termux/files/usr/bin/bash
# AETHER-SYNC v6.9.2 - DavidTX2000

SHADOW="/data/data/com.termux/files/usr/share/aether/shadow"
YELLOW="\033[1;33m"
BLUE="\033[1;34m"
GREEN="\033[1;32m"
RESET="\033[0m"

morph() {
    FREE=$(df -h /data | awk 'NR==2 {print $4}' | sed 's/G//' | cut -d. -f1)
    if [ "$FREE" -le 4 ]; then
        echo -e "${YELLOW}Warning: Please do not delete the cache and data using aether --kill, as we are in the emulation process. Low storage detected ($FREE GB).${RESET}"
    fi

    echo -e "${BLUE}[AETHER]${RESET} Cloning Root File System..."
    
    # 1. Cria a estrutura base sem links primeiro
    mkdir -p "$SHADOW/system/bin"
    mkdir -p "$SHADOW/proc"
    mkdir -p "$SHADOW/product"

    # 2. Clona o sistema real, mas pula o que vamos injetar
    ROOT_PATHS=("/acct" "/apex" "/bin" "/cache" "/config" "/data" "/dev" "/etc" "/mnt" "/odm" "/oem" "/sdcard" "/storage" "/sys" "/vendor")
    for p in "${ROOT_PATHS[@]}"; do
        if [ -d "$p" ]; then
            mkdir -p "$SHADOW$p"
            cp -asf "$p"/. "$SHADOW$p/" 2>/dev/null
        fi
    done

    # 3. Clona o conteúdo de /system e /proc manualmente para evitar sobrepor nossos bins
    cp -asf /system/bin/. "$SHADOW/system/bin/" 2>/dev/null
    cp -asf /proc/. "$SHADOW/proc/" 2>/dev/null
    cp -asf /product/. "$SHADOW/product/" 2>/dev/null

    # 4. Agora injetamos por cima (Como são arquivos reais na Shadow, não dará Read-only)
    rm -f "$SHADOW/system/bin/insmod" "$SHADOW/system/bin/setenforce"
    
    cat <<'INS' > "$SHADOW/system/bin/insmod"
#!/data/data/com.termux/files/usr/bin/bash
echo "insmod: init_module '$1' failed (Exec format error)"
INS
    cat <<'SET' > "$SHADOW/system/bin/setenforce"
#!/data/data/com.termux/files/usr/bin/bash
echo "SELinux: Permissive mode set."
SET
    
    chmod +x "$SHADOW/system/bin/insmod" "$SHADOW/system/bin/setenforce"
    touch "$SHADOW/proc/cpuinfo"
    touch "$SHADOW/product/build.prop"

    cat <<OP > "$SHADOW/.bashrc"
shopt -s nullglob
export PATH="/system/bin:/system/xbin:\$PATH"
export PS1='~#aether\${PWD#$SHADOW}\$: '
alias cd='_cd(){ if [[ "\$1" == /* ]]; then builtin cd "$SHADOW\$1" 2>/dev/null || builtin cd "\$1"; else builtin cd "\$1"; fi; }; _cd'
alias ls='ls --color=auto -F'
alias aether='/data/data/com.termux/files/usr/bin/aether'
export PREFIX="/system"
echo -e "${GREEN}Aether-Sync Core Active (Rootless Root).${RESET}"
OP

    cd "$SHADOW"
    exec bash --rcfile "$SHADOW/.bashrc" -i
}

case "$1" in
    --morph) morph ;;
    --kill) rm -rf "$SHADOW"/* && echo "Shadow Purged." ;;
esac
