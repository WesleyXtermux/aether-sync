#!/data/data/com.termux/files/usr/bin/bash
# AETHER-SYNC v7.3.8 - DavidTX2000

SHADOW="/data/data/com.termux/files/usr/share/aether/shadow"
SAVE_DIR="/data/data/com.termux/files/home"
YELLOW="\033[1;33m"
BLUE="\033[1;34m"
GREEN="\033[1;32m"
RESET="\033[0m"

save_env() {
    echo -e "${BLUE}Filename to be saved (default: aether-save):${RESET}"
    read -r fname
    [ -z "$fname" ] && fname="aether-save"
    echo -e "${BLUE}[AETHER]${RESET} Creating snapshot: ${fname}.aeth..."
    cd "$SHADOW" && tar -cf "${SAVE_DIR}/${fname}.aeth" . 2>/dev/null
    echo -e "${GREEN}Environment saved successfully.${RESET}"
}

morph() {
    echo -e "${YELLOW}Warning: Please do not delete the cache and data using aether --kill, as we are in the emulation process. Low storage detected (4 GB).${RESET}" [cite: 2026-01-29]

    if [ -z "$(ls -A "$SHADOW" 2>/dev/null)" ]; then
        echo -e "${BLUE}[AETHER]${RESET} Cloning Root File System..."
        mkdir -p "$SHADOW/aether_bin"
        
        # CLONAGEM DETALHADA - Pasta por Pasta com Feedback [cite: 2026-01-26]
        for p in $(ls -1 / 2>/dev/null); do
            echo -e "${BLUE}[AETHER]${RESET} Mirroring /$p..."
            mkdir -p "$SHADOW/$p" 2>/dev/null
            cp -asf "/$p"/. "$SHADOW/$p/" 2>/dev/null
            # Pequeno delay para garantir o design original e processamento real
            sleep 0.1
        done
        
        # INJEÇÃO REAL DOS BINÁRIOS (Corrigindo o LIXO do erro anterior) [cite: 2026-01-26]
        cat <<'WHO' > "$SHADOW/aether_bin/whoami"
#!/data/data/com.termux/files/usr/bin/bash
echo "root"
WHO
        cat <<'ID' > "$SHADOW/aether_bin/id"
#!/data/data/com.termux/files/usr/bin/bash
echo "uid=0(root) gid=0(root) groups=0(root)"
ID
        chmod 755 "$SHADOW/aether_bin/whoami" "$SHADOW/aether_bin/id"
        
        echo -e "${BLUE}[AETHER]${RESET} Mirroring Complete." [cite: 2026-01-26]
    fi

    # .bashrc CRUCIAL para as CORES e ALIASES [cite: 2026-01-26]
    cat <<'OP' > "$SHADOW/.bashrc"
export PATH="/aether_bin:/system/bin:/system/xbin:$PATH"
export PS1='\[\033[1;32m\]~#aether${PWD#$SHADOW}\$: \[\033[0m\]'
alias ls='ls --color=auto -F'
alias cd='_cd(){ if [[ "$1" == /* ]]; then builtin cd "/data/data/com.termux/files/usr/share/aether/shadow$1" 2>/dev/null || builtin cd "$1"; else builtin cd "$1"; fi; }; _cd'
export HOME="/root"
mkdir -p /root
cd /
echo -e "\033[1;32mAbsolute Mirror Active.\033[0m"
OP

    exec bash --rcfile "$SHADOW/.bashrc" -i
}

case "$1" in
    --morph) morph ;;
    --save) save_env ;;
    --kill) rm -rf "$SHADOW"/* && echo "Shadow Purged." ;;
esac
