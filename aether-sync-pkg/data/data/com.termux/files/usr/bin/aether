#!/data/data/com.termux/files/usr/bin/bash
# AETHER-SYNC v7.2.0 - DavidTX2000

SHADOW="/data/data/com.termux/files/usr/share/aether/shadow"
YELLOW="\033[1;33m"
BLUE="\033[1;34m"
GREEN="\033[1;32m"
RESET="\033[0m"

morph() {
    FREE=$(df -h /data | awk 'NR==2 {print $4}' | sed 's/G//' | cut -d. -f1)
    if [ "$FREE" -le 4 ]; then
        echo -e "${YELLOW}Warning: Emulation active. Low storage detected ($FREE GB).${RESET}"
    fi

    echo -e "${BLUE}[AETHER]${RESET} Mirroring Absolute System Structure..."
    
    # 1. Preparar pastas críticas e protegidas
    mkdir -p "$SHADOW/aether_bin"
    mkdir -p "$SHADOW/proc/sys/kernel"
    mkdir -p "$SHADOW/sys/fs/selinux"
    mkdir -p "$SHADOW/system/etc/security"
    mkdir -p "$SHADOW/data/system"

    # 2. Clonagem Universal (Todas as pastas da raiz)
    ALL_ROOT=$(ls -1 /)
    for p in $ALL_ROOT; do
        if [ "$p" != "proc" ] && [ "$p" != "sys" ] && [ "$p" != "dev" ]; then
            mkdir -p "$SHADOW/$p"
            cp -asf "/$p"/. "$SHADOW/$p/" 2>/dev/null
        fi
    done

    # 3. Reconstrução de Arquivos Restritos (Conhecimento de Baixo Nível)
    {
        # Simulação de Identidade
        echo 'root' > "$SHADOW/aether_bin/whoami"
        echo 'uid=0(root) gid=0(root) groups=0(root)' > "$SHADOW/aether_bin/id"
        
        # Simulação de Kernel e Segurança
        echo '1' > "$SHADOW/proc/sys/kernel/printk"
        echo '0' > "$SHADOW/sys/fs/selinux/enforce" # Fake Permissive
        echo 'Linux version 5.10.0-aether' > "$SHADOW/proc/version"
        
        # Simulação de Build Properties
        if [ -f /system/build.prop ]; then
            cp /system/build.prop "$SHADOW/system/build.prop"
            sed -i 's/ro.debuggable=0/ro.debuggable=1/g' "$SHADOW/system/build.prop"
        fi

        chmod +x "$SHADOW/aether_bin"/*
    } 2>/dev/null

    # 4. Configuração do Terminal
    cat <<OP > "$SHADOW/.bashrc"
export PATH="$SHADOW/aether_bin:/system/bin:/system/xbin:\$PATH"
export PS1='~#aether\${PWD#$SHADOW}\$: '
alias cd='_cd(){ if [[ "\$1" == /* ]]; then builtin cd "$SHADOW\$1" 2>/dev/null || builtin cd "\$1"; else builtin cd "\$1"; fi; }; _cd'
alias ls='ls --color=auto -F'
alias aether='/data/data/com.termux/files/usr/bin/aether'
export HOME="/root"
mkdir -p /root
cd /
echo -e "${GREEN}Absolute Mirror Active (Restricted Areas Injected).${RESET}"
OP

    cd "$SHADOW"
    exec bash --rcfile "$SHADOW/.bashrc" -i
}

case "$1" in
    --morph) morph ;;
    --kill) rm -rf "$SHADOW"/* && echo "Shadow Purged." ;;
    *) echo "Usage: aether [--morph|--kill]" ;;
esac
