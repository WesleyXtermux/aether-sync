#!/data/data/com.termux/files/usr/bin/bash
# AETHER-SYNC v7.3.2 - DavidTX2000

SHADOW="/data/data/com.termux/files/usr/share/aether/shadow"
SAVE_DIR="/data/data/com.termux/files/home"
YELLOW="\033[1;33m"
BLUE="\033[1;34m"
GREEN="\033[1;32m"
RESET="\033[0m"

save_env() {
    echo -e "${BLUE}Filename to be saved (default: aether-save):${RESET}"
    read -r fname
    [ -z "$fname" ] && fname="aether-save"
    echo -e "${BLUE}[AETHER]${RESET} Creating snapshot: ${fname}.aeth..."
    cd "$SHADOW" && tar -cf "${SAVE_DIR}/${fname}.aeth" . 2>/dev/null
    echo -e "${GREEN}Environment saved successfully.${RESET}"
}

load_env() {
    echo -e "${BLUE}Filename to be loaded:${RESET}"
    read -r fname
    if [ ! -f "${SAVE_DIR}/${fname}.aeth" ]; then
        echo -e "${YELLOW}Error: File ${fname}.aeth not found.${RESET}"
        return 1
    fi
    echo -e "${BLUE}[AETHER]${RESET} Loading snapshot..."
    rm -rf "$SHADOW"/* 2>/dev/null
    mkdir -p "$SHADOW"
    tar -xf "${SAVE_DIR}/${fname}.aeth" -C "$SHADOW" 2>/dev/null
    echo -e "${GREEN}Snapshot loaded.${RESET}"
}

morph() {
    FREE=$(df -h /data | awk 'NR==2 {print $4}' | sed 's/G//' | cut -d. -f1)
    if [ "$FREE" -le 4 ]; then
        echo -e "${YELLOW}Warning: Please do not delete the cache and data using aether --kill, as we are in the emulation process. Low storage detected ($FREE GB).${RESET}"
    fi

    if [ -z "$(ls -A "$SHADOW" 2>/dev/null)" ]; then
        echo -e "${BLUE}[AETHER]${RESET} Mirroring System Structure..."
        mkdir -p "$SHADOW/aether_bin" "$SHADOW/root"
        
        # Clonagem estruturada para evitar erros de permissão
        PATHS=("/bin" "/etc" "/system" "/vendor" "/data" "/sdcard" "/storage" "/proc" "/sys" "/product")
        for p in "${PATHS[@]}"; do
            if [ -d "$p" ]; then
                mkdir -p "$SHADOW$p" 2>/dev/null
                cp -asf "$p"/. "$SHADOW$p/" 2>/dev/null
            fi
        done
        
        # Injeção de Identidade [cite: 2026-01-26]
        echo 'root' > "$SHADOW/aether_bin/whoami"
        echo 'uid=0(root) gid=0(root) groups=0(root)' > "$SHADOW/aether_bin/id"
        chmod +x "$SHADOW/aether_bin"/*
    fi

    cat <<OP > "$SHADOW/.bashrc"
export PATH="$SHADOW/aether_bin:/system/bin:/system/xbin:\$PATH"
export PS1='~#aether\${PWD#$SHADOW}\$: '
alias ls='ls --color=auto -F'
alias cd='_cd(){ if [[ "\$1" == /* ]]; then builtin cd "$SHADOW\$1" 2>/dev/null || builtin cd "\$1"; else builtin cd "\$1"; fi; }; _cd'
alias aether='/data/data/com.termux/files/usr/bin/aether'
export HOME="/root"
cd /
echo -e "${GREEN}Absolute Mirror Active.${RESET}"
OP

    exec bash --rcfile "$SHADOW/.bashrc" -i
}

case "$1" in
    --morph) morph ;;
    --save) save_env ;;
    "--save{load}") load_env ;;
    "--save{delete}") rm -f "${SAVE_DIR}/*.aeth" && echo "Deleted." ;;
    --kill) rm -rf "$SHADOW"/* && echo "Shadow Purged." ;;
esac
